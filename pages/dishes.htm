title = "Dishes"
url = "/dishes"
layout = "default"
==
<?php
function onStart()
{
    $this['currentPage'] = 'dish';
    $this['dishes'] = Plugins\Responsiv\DishSmith\Models\Dish::ofUser(Auth::getUser())->get();
}

function onSaveDish()
{
    $user = Auth::getUser();
    $dish = Plugins\Responsiv\DishSmith\Models\Dish::create([
                'name' => post('name'),
                'user_id' => $user->id
            ]);

    $ingredients = $this->getIngredients();

    foreach ($ingredients as $ingredientData) {
        $ingredient = Plugins\Responsiv\DishSmith\Models\Ingredient::firstOrCreate(['name' => $ingredientData['name']]);

        $dish->ingredients()->attach($ingredient->id, [
            'type' => trim($ingredientData['type']),
            'amount' => trim($ingredientData['amount'])
        ]);
    }

    $this['dishes'] = Plugins\Responsiv\DishSmith\Models\Dish::ofUser(Auth::getUser())->get();
}

function onNewDish() {}

function onAddIngredient()
{
    $ingredients = $this->getIngredients();
    $ingredients[] = [
        'name' => post('ingredient'),
        'type' => post('type'),
        'amount' => post('amount'),
    ];

    $this['ingredients'] = $ingredients;
    $this['dishName'] = post('name');
}

function getIngredients()
{
    $ingredients = [];
    $ingredientsRaw = post('ingredients');
    if (isset($ingredientsRaw['name'])) {
        foreach ($ingredientsRaw['name'] as $key => $value) {
            $ingredients[] = [
                'name' => $value,
                'type' => $ingredientsRaw['type'][$key],
                'amount' => $ingredientsRaw['amount'][$key]
            ];
        }
    }

    return $ingredients;
}

function onDeleteDish()
{
    if (!post('dish_id'))
        return;
    
    $dish = Plugins\Responsiv\DishSmith\Models\Dish::ofUser(Auth::getUser())->find(post('dish_id'));
    if ($dish) {
        $dish->ingredients()->detach();
        $dish->delete();
    }

    $this['dishes'] = Plugins\Responsiv\DishSmith\Models\Dish::ofUser(Auth::getUser())->get();
}
?>
==
{% put scripts %}
<script>
    $(document).on('keyup', '#inputDishName', function(){
        var name = $(this).val()
        if (!name) 
            $('#previewDishName').html('<span class="text-muted">No name</span>')
        else
            $('#previewDishName').text(name)
    })

    function clearIngredientsForm() {
        $('#inputIngredientAmount, #inputIngredientName').val('')
        $('#inputIngredientAmount').focus()
        $('#previewIngredientNumber').text($('#partialDishesIngredients li').length)
    }

    function removeIngredientItem(el) {
        $(el).closest('li').remove()
        $('#previewIngredientNumber').text($('#partialDishesIngredients li').length)
    }
</script>
{% endput %}

<div class="dishes-page" id="dishesPage">

    <div id="partialDishesDishes" class="dishes">
        {% partial 'dishes/dishes' %}
    </div>

    <!-- Form -->
    <div class="row dish-form" id="partialDishesForm">
        {% partial 'dishes/form' %}
    </div>

</div>
